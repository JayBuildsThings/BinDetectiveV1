<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bin Detective Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- GOOGLE MAPS JS -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgAjnhHwg21ujdM12Y4VDlNOg8ujpxcP4"></script>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        "primary": "#ec1313", 
                        "dark": "#221010",
                        "status-green": "#10b981",
                        "status-gray": "#9ca3af"
                    },
                    fontFamily: { "display": ["Lexend", "sans-serif"] }
                }
            }
        }
    </script>
    <style>
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #map { height: 600px; width: 100%; border-radius: 1rem; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 font-display">

    <!-- AUTH LOCK SCREEN OVERLAY -->
    <div id="lock-screen" class="fixed inset-0 z-[100] bg-dark flex items-center justify-center p-6 hidden">
        <div class="max-w-sm w-full bg-white rounded-3xl p-8 shadow-2xl text-center">
            <div class="w-20 h-20 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="material-symbols-outlined text-4xl">lock</span>
            </div>
            <h2 class="text-2xl font-black mb-2">Secure Sign In</h2>
            <p class="text-gray-500 text-sm mb-6">Use your email and password to continue.</p>
            <div class="flex flex-col gap-3 text-left">
                <input type="email" id="auth-email" placeholder="Email address" autocomplete="email"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
                <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
                <input type="text" id="auth-company" placeholder="Company name"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            </div>
            <div class="grid grid-cols-2 gap-3 mt-5">
                <button onclick="signIn()" class="w-full h-12 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                    SIGN IN
                </button>
                <button onclick="signUp()" class="w-full h-12 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                    SIGN UP
                </button>
            </div>
            <button type="button" onclick="requestPasswordReset()" class="mt-4 text-xs font-bold text-gray-400 hover:text-primary transition-colors">
                Forgot password?
            </button>
            <p id="auth-message" class="text-xs text-gray-500 mt-4 min-h-[16px]"></p>
        </div>
    </div>

    <!-- PASSWORD RESET MODAL -->
    <div id="reset-password-modal" class="fixed inset-0 z-[110] bg-black/40 hidden items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-black text-dark">Set Password</h2>
                <button onclick="closeResetPassword()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <p class="text-xs text-gray-500 mb-4">Create a password for your account.</p>
            <div class="flex flex-col gap-3">
                <input type="password" id="reset-password" placeholder="New password"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
                <input type="password" id="reset-password-confirm" placeholder="Confirm new password"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            </div>
            <p id="reset-message" class="text-xs text-gray-500 mt-3 min-h-[16px]"></p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeResetPassword()" class="flex-1 h-11 rounded-xl bg-gray-100 text-gray-600 font-bold">Cancel</button>
                <button onclick="submitPasswordReset()" class="flex-1 h-11 rounded-xl bg-primary text-white font-bold">Update</button>
            </div>
        </div>
    </div>

    <!-- LOGOUT CONFIRM MODAL -->
    <div id="logout-modal" class="fixed inset-0 z-[110] bg-black/40 hidden items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl text-center">
            <div class="w-16 h-16 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-3xl">logout</span>
            </div>
            <h2 class="text-lg font-black text-dark mb-2">Log out?</h2>
            <p class="text-xs text-gray-500 mb-6">Are you sure you want to log out?</p>
            <div class="flex gap-3">
                <button onclick="closeLogoutModal()" class="flex-1 h-11 rounded-xl bg-gray-100 text-gray-600 font-bold">Cancel</button>
                <button onclick="confirmLogout()" class="flex-1 h-11 rounded-xl bg-primary text-white font-bold">Log out</button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="max-w-7xl mx-auto min-h-screen p-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-gray-200 pb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-dark tracking-tight">BIN <span class="text-primary">DETECTIVE</span></h1>
                <p class="text-gray-500 text-sm mt-1">Real-time inventory management</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="switchView('overview')" id="nav-overview" class="nav-btn bg-dark text-white px-4 py-2 rounded-lg font-bold text-sm transition-all hover:opacity-80">Overview</button>
                <button onclick="switchView('map')" id="nav-map" class="nav-btn bg-white text-gray-500 border border-gray-200 px-4 py-2 rounded-lg font-bold text-sm transition-all hover:text-primary hover:border-primary flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">map</span> Map
                </button>
                <button onclick="openAddBin()" class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-sm transition-all hover:opacity-90 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">add</span> Add Bin
                </button>
                <div class="w-px h-8 bg-gray-200 mx-2"></div>
                <a href="manage.html" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-primary transition-colors">
                    <span>Open App</span>
                    <span class="material-symbols-outlined text-lg">open_in_new</span>
                </a>
                <button onclick="logout()" class="text-sm font-bold text-gray-400 hover:text-primary transition-colors">
                    Logout
                </button>
            </div>
        </header>

        <!-- ADD BIN MODAL -->
        <div id="add-bin-modal" class="fixed inset-0 z-[110] bg-black/40 hidden items-center justify-center p-6">
            <div class="w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-black text-dark">Add Bin</h2>
                    <button onclick="closeAddBin()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Bin ID</label>
                <input type="text" id="new-bin-id" placeholder="e.g. 101" class="w-full rounded-xl border-gray-200 h-12 focus:border-primary focus:ring-primary text-gray-700">
                <div class="flex gap-3 mt-5">
                    <button onclick="closeAddBin()" class="flex-1 h-11 rounded-xl bg-gray-100 text-gray-600 font-bold">Cancel</button>
                    <button onclick="submitAddBin()" class="flex-1 h-11 rounded-xl bg-primary text-white font-bold">Add</button>
                </div>
            </div>

        </div>

        <!-- VIEW: OVERVIEW -->
        <div id="view-overview" class="view active">
            <!-- Sub Tabs -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button id="tab-bins" onclick="switchDashboardTab('bins')" class="nav-btn bg-dark text-white px-4 py-2 rounded-lg font-bold text-sm transition-all">
                    Bins
                </button>
                <button id="tab-users" onclick="switchDashboardTab('users')" class="nav-btn bg-white text-gray-500 border border-gray-200 px-4 py-2 rounded-lg font-bold text-sm transition-all hover:text-primary hover:border-primary">
                    Users
                </button>
                <button id="tab-contacts" onclick="switchDashboardTab('contacts')" class="nav-btn bg-white text-gray-500 border border-gray-200 px-4 py-2 rounded-lg font-bold text-sm transition-all hover:text-primary hover:border-primary">
                    Contacts
                </button>
            </div>

            <!-- TAB: BINS -->
            <div id="dashboard-tab-bins" class="dashboard-tab">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="p-3 bg-blue-50 text-blue-600 rounded-xl">
                        <span class="material-symbols-outlined">inventory_2</span>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Bins</p>
                        <p id="stat-total" class="text-2xl font-black text-dark">--</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="p-3 bg-green-50 text-green-600 rounded-xl">
                        <span class="material-symbols-outlined">local_shipping</span>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase">Delivered</p>
                        <p id="stat-delivered" class="text-2xl font-black text-dark">--</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                    <div class="p-3 bg-gray-100 text-gray-600 rounded-xl">
                        <span class="material-symbols-outlined">warehouse</span>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase">Not at site</p>
                        <p id="stat-warehouse" class="text-2xl font-black text-dark">--</p>
                    </div>
                </div>
            </div>

            <!-- Search & Filter -->
            <div class="bg-white p-4 rounded-t-2xl border border-gray-200 border-b-0 flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="relative w-full md:w-96">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input type="text" id="table-search" placeholder="Search Bin #, Client, or Address..." 
                           class="w-full pl-10 pr-4 py-2 bg-gray-50 border-gray-200 rounded-lg focus:ring-primary focus:border-primary text-sm"
                           oninput="filterTable()">
                </div>
                <div class="flex gap-2">
                    <button onclick="fetchDashboardData()" class="p-2 text-gray-400 hover:text-primary transition-colors" title="Refresh">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-b-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4">Bin #</th>
                                <th class="px-6 py-4">Current Status</th>
                                <th class="px-6 py-4">Days at Site</th>
                                <th class="px-6 py-4">Client</th>
                                <th class="px-6 py-4">Location</th>
                                <th class="px-6 py-4">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-body" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="px-6 py-10 text-center text-gray-400">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>

            <!-- TAB: USERS -->
            <div id="dashboard-tab-users" class="dashboard-tab hidden">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <h2 class="text-lg font-black text-dark mb-1">Users</h2>
                    <p id="users-admin-banner" class="text-sm text-gray-500">Only admins can manage users.</p>
                </div>

                <div id="users-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Users</p>
                        <p id="users-total" class="text-2xl font-black text-dark">--</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase">Admins</p>
                        <p id="users-admins" class="text-2xl font-black text-dark">--</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase">Standard</p>
                        <p id="users-standard" class="text-2xl font-black text-dark">--</p>
                    </div>
                </div>

                <div id="users-no-access" class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center hidden">
                    <h3 class="text-xl font-black text-dark mb-2">Admin Access Required</h3>
                    <p class="text-gray-500">You need admin permissions to view the user list.</p>
                </div>

                <div id="users-table-wrap" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-4">Email</th>
                                    <th class="px-6 py-4">Role</th>
                                    <th class="px-6 py-4">Dashboard Access</th>
                                    <th class="px-6 py-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="users-body" class="divide-y divide-gray-100">
                                <tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: CONTACTS -->
            <div id="dashboard-tab-contacts" class="dashboard-tab hidden">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <h2 class="text-lg font-black text-dark mb-1">Contacts</h2>
                    <p class="text-sm text-gray-500">Overview of client contact details.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Contacts</p>
                        <p id="contacts-total" class="text-2xl font-black text-dark">--</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase">With Phone</p>
                        <p id="contacts-phone" class="text-2xl font-black text-dark">--</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase">With Address</p>
                        <p id="contacts-address" class="text-2xl font-black text-dark">--</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-t-2xl border border-gray-200 border-b-0 flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div class="relative w-full md:w-96">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        <input type="text" id="contacts-search" placeholder="Search name, phone, or address..."
                               class="w-full pl-10 pr-4 py-2 bg-gray-50 border-gray-200 rounded-lg focus:ring-primary focus:border-primary text-sm"
                               oninput="filterContacts()">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadContacts()" class="p-2 text-gray-400 hover:text-primary transition-colors" title="Refresh">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-b-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-4">Name</th>
                                    <th class="px-6 py-4">Phone</th>
                                    <th class="px-6 py-4">Address</th>
                                    <th class="px-6 py-4">Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-body" class="divide-y divide-gray-100">
                                <tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Loading contacts...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: MAP -->
        <div id="view-map" class="view">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-dark">Bin Locations</h2>
                    <span class="text-xs font-bold text-gray-400 uppercase bg-gray-100 px-3 py-1 rounded-full">Showing Assigned Bins</span>
                </div>
                
                <!-- Map Container -->
                <div id="map"></div>
                
                <div class="mt-4 flex gap-4 text-xs font-bold text-gray-500">
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Assigned (Delivered)</div>
                    <!-- Unassigned are hidden as per request -->
                </div>
            </div>
        </div>

    </div>

    <script>
        const supabaseUrl = 'https://sjpzozgslahdzwqwjtbr.supabase.co';
        const supabaseKey = 'sb_publishable_t01aoRgIetSZ1Fuz0VSrgg_twswmqZV';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let allRows = [];
        let allContacts = [];
        let allUsers = [];
        let map;
        let markers = [];
        let activeDashboardTab = 'bins';
        let contactsLoaded = false;
        let usersLoaded = false;

        let currentCompanyId = null;
        let currentUser = null;
        let currentIsAdmin = false;
        let currentDashboardAccess = true;

        function showLockScreen(show) {
            const lockScreen = document.getElementById('lock-screen');
            lockScreen.classList.toggle('hidden', !show);
        }

        function redirectToLogin() {
            window.location.href = "login.html";
        }

        function redirectToManage() {
            window.location.href = "manage.html";
        }

        function showLogoutModal(show) {
            const modal = document.getElementById('logout-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        }

        window.closeLogoutModal = function() {
            showLogoutModal(false);
        };

        window.confirmLogout = async function() {
            try {
                await Promise.race([
                    supabase.auth.signOut(),
                    new Promise(resolve => setTimeout(resolve, 2000))
                ]);
            } catch (e) {
                console.warn('Logout failed', e);
            }
            showLogoutModal(false);
            redirectToLogin();
        };

        function setAuthMessage(message, isError = false) {
            const el = document.getElementById('auth-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-4 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        function showResetPassword(show) {
            const modal = document.getElementById('reset-password-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        }

        function setResetMessage(message, isError = false) {
            const el = document.getElementById('reset-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-3 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        function isPasswordSetupFlow() {
            const hash = window.location.hash || '';
            return hash.includes('type=recovery') || hash.includes('type=invite');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function runWithRetry(label, fn, attempts = 3) {
            let lastError;
            for (let attempt = 1; attempt <= attempts; attempt++) {
                const { data, error } = await fn();
                if (!error) return { data };
                lastError = error;
                console.warn(`${label} attempt ${attempt} failed`, error);
                await sleep(400 * attempt);
            }
            return { error: lastError };
        }

        function setDashboardError(message) {
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-red-500">
                        ${message}
                        <div class="mt-3">
                            <button onclick="fetchDashboardData()" class="text-xs font-bold text-primary underline">Retry</button>
                        </div>
                    </td>
                </tr>`;
        }

        function setUsersError(message) {
            const tbody = document.getElementById('users-body');
            if (!tbody) return;
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="px-6 py-10 text-center text-red-500">
                        ${message}
                        <div class="mt-3">
                            <button onclick="loadUsers()" class="text-xs font-bold text-primary underline">Retry</button>
                        </div>
                    </td>
                </tr>`;
        }

        function setContactsError(message) {
            const tbody = document.getElementById('contacts-body');
            if (!tbody) return;
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-10 text-center text-red-500">
                        ${message}
                        <div class="mt-3">
                            <button onclick="loadContacts()" class="text-xs font-bold text-primary underline">Retry</button>
                        </div>
                    </td>
                </tr>`;
        }

        async function loadCompanyId() {
            const { data } = await supabase
                .from('company_users')
                .select('company_id')
                .eq('user_id', currentUser.id)
                .maybeSingle();
            if (data?.company_id) {
                currentCompanyId = data.company_id;
                return true;
            }
            currentIsAdmin = false;
            currentDashboardAccess = true;
            updateUsersNavVisibility();
            return false;
        }

        async function loadAccessTier() {
            if (!currentCompanyId || !currentUser?.email) {
                currentIsAdmin = false;
                currentDashboardAccess = false;
                updateUsersNavVisibility();
                return false;
            }
            const { data } = await supabase
                .from('company_allowed_emails')
                .select('is_admin,dashboard_access')
                .eq('company_id', currentCompanyId)
                .eq('email', currentUser.email)
                .maybeSingle();
            if (data) {
                currentIsAdmin = !!data.is_admin;
                currentDashboardAccess = data.dashboard_access !== false;
                updateUsersNavVisibility();
                return true;
            }
            currentIsAdmin = false;
            currentDashboardAccess = false;
            updateUsersNavVisibility();
            return false;
        }

        async function ensureCompanyMembership() {
            const companyName = document.getElementById('auth-company').value.trim();
            const email = (currentUser?.email || '').trim();
            if (!companyName || !email) {
                setAuthMessage('Enter your company name to continue.', true);
                return false;
            }
            const { error } = await supabase.rpc('claim_company_by_email', {
                p_company_name: companyName,
                p_email: email
            });
            if (error && !String(error.message).toLowerCase().includes('duplicate key')) {
                setAuthMessage(error.message, true);
                return false;
            }
            return loadCompanyId();
        }

        async function postAuthInit() {
            if (!currentUser) return;
            const hasCompany = await loadCompanyId();
            if (!hasCompany) {
                const claimed = await ensureCompanyMembership();
                if (!claimed) {
                    showLockScreen(true);
                    return;
                }
            }
            const hasAccess = await loadAccessTier();
            if (!hasAccess || !currentDashboardAccess) {
                redirectToManage();
                return;
            }
            showLockScreen(false);
            switchDashboardTab(activeDashboardTab);
            fetchDashboardData();
        }

        window.requestPasswordReset = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            if (!email) {
                setAuthMessage('Enter your email to reset your password.', true);
                return;
            }
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: `${window.location.origin}/BinDetectiveV1/set-password.html`
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            setAuthMessage('If the email is registered, a password reset link has been sent.');
        };

        window.closeResetPassword = function() {
            showResetPassword(false);
            setResetMessage('');
            const pwd = document.getElementById('reset-password');
            const confirm = document.getElementById('reset-password-confirm');
            if (pwd) pwd.value = '';
            if (confirm) confirm.value = '';
        };

        window.submitPasswordReset = async function() {
            setResetMessage('');
            const pwd = document.getElementById('reset-password').value.trim();
            const confirm = document.getElementById('reset-password-confirm').value.trim();
            if (!pwd || pwd.length < 6) {
                setResetMessage('Password must be at least 6 characters.', true);
                return;
            }
            if (pwd !== confirm) {
                setResetMessage('Passwords do not match.', true);
                return;
            }
            const { error } = await supabase.auth.updateUser({ password: pwd });
            if (error) {
                setResetMessage(error.message, true);
                return;
            }
            setResetMessage('Password updated. Please sign in again.');
            await supabase.auth.signOut();
            showResetPassword(false);
            showLockScreen(true);
        };

        function updateUsersNavVisibility() {
            const banner = document.getElementById('users-admin-banner');
            if (!banner) return;
            banner.innerText = currentIsAdmin
                ? 'Manage and review user access for this company.'
                : 'Only admins can manage users.';
        }

        window.signIn = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.signUp = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: "https://jaybuildsthings.github.io/BinDetectiveV1/dashboard.html"
                }
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            if (!data.session) {
                setAuthMessage('Check your email to confirm your account.');
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.logout = async function() {
            showLogoutModal(true);
        };

        window.openAddBin = function() {
            if (!currentCompanyId) {
                alert("Company access missing. Please sign in again.");
                return;
            }
            document.getElementById('new-bin-id').value = '';
            document.getElementById('add-bin-modal').classList.remove('hidden');
            document.getElementById('add-bin-modal').classList.add('flex');
        };

        window.closeAddBin = function() {
            const modal = document.getElementById('add-bin-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        window.submitAddBin = async function() {
            const binId = document.getElementById('new-bin-id').value.trim();
            if (!binId) {
                alert("Please enter a bin ID.");
                return;
            }
            if (!currentCompanyId) {
                alert("Company access missing. Please sign in again.");
                return;
            }

            const { error } = await supabase.from('master_bins').insert([{
                company_id: currentCompanyId,
                bin_id: binId
            }]);

            if (error) {
                alert(error.message);
                return;
            }

            closeAddBin();
            fetchDashboardData();
        };

        // --- INIT ---
        async function init() {
            const { data } = await supabase.auth.getSession();
            if (data.session && isPasswordSetupFlow()) {
                showLockScreen(true);
                showResetPassword(true);
                return;
            }
            if (!data.session) {
                redirectToLogin();
                return;
            } else {
                currentUser = data.session.user;
                await postAuthInit();
            }
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'PASSWORD_RECOVERY' || isPasswordSetupFlow()) {
                    showLockScreen(true);
                    showResetPassword(true);
                    return;
                }
                if (!session) {
                    currentUser = null;
                    currentCompanyId = null;
                    redirectToLogin();
                    return;
                }
                currentUser = session.user;
                await postAuthInit();
            });
        }

        // --- NAVIGATION & MAP RESIZE ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Button Styles
            const btnOverview = document.getElementById('nav-overview');
            const btnMap = document.getElementById('nav-map');
            
            const activeClass = "bg-dark text-white border-transparent";
            const inactiveClass = "bg-white text-gray-500 border-gray-200 hover:text-primary hover:border-primary";
            
            if(viewName === 'overview') {
                btnOverview.className = `nav-btn px-4 py-2 rounded-lg font-bold text-sm transition-all ${activeClass}`;
                btnMap.className = `nav-btn border px-4 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2 ${inactiveClass}`;
            } else {
                btnMap.className = `nav-btn border px-4 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2 ${activeClass}`;
                btnOverview.className = `nav-btn px-4 py-2 rounded-lg font-bold text-sm transition-all ${inactiveClass}`;
                
                // Initialize Map if not already done
                setTimeout(() => {
                    if (!map) initMap();
                }, 100);
            }
        };

        window.switchDashboardTab = function(tabName) {
            activeDashboardTab = tabName;
            document.querySelectorAll('.dashboard-tab').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`dashboard-tab-${tabName}`);
            if (target) target.classList.remove('hidden');

            const btnBins = document.getElementById('tab-bins');
            const btnUsers = document.getElementById('tab-users');
            const btnContacts = document.getElementById('tab-contacts');
            const activeClass = "bg-dark text-white border-transparent";
            const inactiveClass = "bg-white text-gray-500 border-gray-200 hover:text-primary hover:border-primary";
            if (btnBins) btnBins.className = `nav-btn px-4 py-2 rounded-lg font-bold text-sm transition-all ${tabName === 'bins' ? activeClass : inactiveClass}`;
            if (btnUsers) btnUsers.className = `nav-btn px-4 py-2 rounded-lg font-bold text-sm transition-all ${tabName === 'users' ? activeClass : inactiveClass}`;
            if (btnContacts) btnContacts.className = `nav-btn px-4 py-2 rounded-lg font-bold text-sm transition-all ${tabName === 'contacts' ? activeClass : inactiveClass}`;

            if (tabName === 'users') {
                const noAccess = document.getElementById('users-no-access');
                const summary = document.getElementById('users-summary');
                const tableWrap = document.getElementById('users-table-wrap');
                if (!currentIsAdmin) {
                    if (noAccess) noAccess.classList.remove('hidden');
                    if (summary) summary.classList.add('hidden');
                    if (tableWrap) tableWrap.classList.add('hidden');
                    return;
                }
                if (noAccess) noAccess.classList.add('hidden');
                if (summary) summary.classList.remove('hidden');
                if (tableWrap) tableWrap.classList.remove('hidden');
                if (!usersLoaded) loadUsers();
            }

            if (tabName === 'contacts' && !contactsLoaded) {
                loadContacts();
            }
        };

        // --- MAP LOGIC ---
        function initMap() {
            const defaultCenter = { lat: -30.5595, lng: 22.9375 };
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 5,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });
            updateMapMarkers();
        }

        async function updateMapMarkers() {
            if (!map || allRows.length === 0) return;

            markers.forEach(m => m.setMap(null));
            markers = [];

            const assignedBins = allRows.filter(r => r.status === 'Delivered');
            const geocoder = new google.maps.Geocoder();
            const bounds = new google.maps.LatLngBounds();

            for (let i = 0; i < assignedBins.length; i++) {
                const row = assignedBins[i];
                if (!row.address || row.address === '-') continue;

                const coords = await new Promise(resolve => {
                    geocoder.geocode({ address: row.address }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            resolve(results[0].geometry.location);
                        } else {
                            resolve(null);
                        }
                    });
                });

                if (coords) {
                    const marker = new google.maps.Marker({
                        map,
                        position: coords,
                        title: `Bin #${row.id}`
                    });
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="font-sans">
                                <h3 class="font-bold text-sm">Bin #${row.id}</h3>
                                <p class="text-xs text-gray-500">${row.client}</p>
                                <p class="text-xs mt-1 font-mono">${row.address}</p>
                            </div>
                        `
                    });
                    marker.addListener('click', () => infoWindow.open({ anchor: marker, map }));
                    markers.push(marker);
                    bounds.extend(coords);
                }
            }

            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
            }
        }

        // --- DASHBOARD DATA ---
        async function fetchDashboardData() {
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-400">Loading data...</td></tr>`;
            const binsRes = await runWithRetry('master_bins', () => supabase.from('master_bins').select('bin_id'));
            if (binsRes.error) {
                setDashboardError(binsRes.error.message || 'Unable to load bins.');
                return;
            }
            const logsRes = await runWithRetry('activity_logs', () => supabase
                .from('activity_logs')
                .select('bin_id,activity_type,client_name,address,created_at')
                .order('created_at', { ascending: false }));
            if (logsRes.error) {
                setDashboardError(logsRes.error.message || 'Unable to load activity logs.');
                return;
            }

            const bins = binsRes.data || [];
            const logs = logsRes.data || [];

            const binMap = new Map();
            bins.forEach(b => {
                binMap.set(b.bin_id, { id: b.bin_id, status: 'Not at site', days: '-', client: '-', address: '-', date: '-', rawDate: 0 });
            });

            logs.forEach(log => {
                if (binMap.has(log.bin_id)) {
                    const currentEntry = binMap.get(log.bin_id);
                    if (currentEntry.rawDate === 0) {
                        let status = 'Not at site';
                        let days = '-';
                        if (log.activity_type === 'Deliver') {
                            status = 'Delivered';
                            const diffTime = Math.floor((new Date() - new Date(log.created_at)) / (1000 * 60 * 60 * 24));
                            days = diffTime === 0 ? 'Today' : `${diffTime} day${diffTime === 1 ? '' : 's'}`;
                        }
                        binMap.set(log.bin_id, {
                            id: log.bin_id,
                            status: status,
                            days: days,
                            client: log.client_name || '-',
                            address: log.address || '-',
                            date: new Date(log.created_at).toLocaleDateString(),
                            rawDate: new Date(log.created_at).getTime()
                        });
                    }
                }
            });

            allRows = Array.from(binMap.values()).sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }));
            updateStats();
            renderTable(allRows);
            
            // Trigger Map Update if map is active
            if (document.getElementById('view-map').classList.contains('active')) {
                updateMapMarkers();
            }
        }

        function renderTable(rows) {
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = '';
            rows.forEach(row => {
                const isDelivered = row.status === 'Delivered';
                const statusClass = isDelivered ? 'bg-green-100 text-green-700 border-green-200' : 'bg-gray-100 text-gray-500 border-gray-200';
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition-colors group">
                        <td class="px-6 py-4 font-black text-dark">#${row.id}</td>
                        <td class="px-6 py-4"><span class="px-2.5 py-1 rounded-md text-xs font-bold uppercase tracking-wide border ${statusClass}">${row.status}</span></td>
                        <td class="px-6 py-4 font-bold text-gray-600">${row.days}</td>
                        <td class="px-6 py-4 font-medium text-gray-700">${row.client}</td>
                        <td class="px-6 py-4 text-gray-500 max-w-xs truncate" title="${row.address}">${row.address}</td>
                        <td class="px-6 py-4 text-gray-400 text-xs font-mono">${row.date}</td>
                    </tr>`;
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = allRows.length;
            document.getElementById('stat-delivered').innerText = allRows.filter(r => r.status === 'Delivered').length;
            document.getElementById('stat-warehouse').innerText = allRows.length - allRows.filter(r => r.status === 'Delivered').length;
        }

        window.filterTable = function() {
            const query = document.getElementById('table-search').value.toLowerCase();
            const filtered = allRows.filter(r => r.id.toLowerCase().includes(query) || r.client.toLowerCase().includes(query) || r.address.toLowerCase().includes(query));
            renderTable(filtered);
        };

        async function loadUsers() {
            const tbody = document.getElementById('users-body');
            if (!tbody || !currentCompanyId) return;
            tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-10 text-center text-gray-400">Loading users...</td></tr>';
            const res = await runWithRetry('allowed emails', () => supabase
                .from('company_allowed_emails')
                .select('id,email,is_admin,dashboard_access')
                .eq('company_id', currentCompanyId)
                .order('email', { ascending: true }));
            if (res.error) {
                setUsersError(res.error.message || 'Unable to load users.');
                return;
            }
            const data = res.data || [];
            allUsers = data;
            usersLoaded = true;
            updateUsersSummary(data);
            renderUsersTable(data);
        }

        function updateUsersSummary(users) {
            const total = users.length;
            const admins = users.filter(u => u.is_admin).length;
            const standard = total - admins;
            const elTotal = document.getElementById('users-total');
            const elAdmins = document.getElementById('users-admins');
            const elStandard = document.getElementById('users-standard');
            if (elTotal) elTotal.innerText = total;
            if (elAdmins) elAdmins.innerText = admins;
            if (elStandard) elStandard.innerText = standard;
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-body');
            if (!tbody) return;
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">No users yet.</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(row => {
                const role = row.is_admin ? 'Admin' : 'User';
                const statusClass = row.is_admin ? 'bg-primary/10 text-primary border-primary/20' : 'bg-gray-100 text-gray-600 border-gray-200';
                const accessEnabled = row.dashboard_access !== false;
                const accessClass = accessEnabled ? 'bg-green-100 text-green-700 border-green-200' : 'bg-gray-100 text-gray-600 border-gray-200';
                const accessLabel = accessEnabled ? 'Enabled' : 'Disabled';
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-800">${row.email}</td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-md text-xs font-bold uppercase tracking-wide border ${statusClass}">${role}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-md text-xs font-bold uppercase tracking-wide border ${accessClass}">${accessLabel}</span>
                        </td>
                        <td class="px-6 py-4 text-gray-500">Allowed</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadContacts() {
            const tbody = document.getElementById('contacts-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Loading contacts...</td></tr>';
            const res = await runWithRetry('contacts', () => supabase
                .from('activity_logs')
                .select('client_name,address,phone_number,created_at')
                .order('created_at', { ascending: false })
                .limit(1000));
            if (res.error) {
                setContactsError(res.error.message || 'Unable to load contacts.');
                return;
            }
            const data = res.data || [];
            const uniqueClients = new Map();
            data.forEach(log => {
                if (!log.client_name) return;
                if (!uniqueClients.has(log.client_name)) {
                    uniqueClients.set(log.client_name, log);
                }
            });
            allContacts = Array.from(uniqueClients.values()).sort((a, b) => a.client_name.localeCompare(b.client_name));
            contactsLoaded = true;
            updateContactsSummary(allContacts);
            renderContactsTable(allContacts);
        }

        function updateContactsSummary(contacts) {
            const total = contacts.length;
            const withPhone = contacts.filter(c => c.phone_number).length;
            const withAddress = contacts.filter(c => c.address).length;
            const elTotal = document.getElementById('contacts-total');
            const elPhone = document.getElementById('contacts-phone');
            const elAddress = document.getElementById('contacts-address');
            if (elTotal) elTotal.innerText = total;
            if (elPhone) elPhone.innerText = withPhone;
            if (elAddress) elAddress.innerText = withAddress;
        }

        function renderContactsTable(contacts) {
            const tbody = document.getElementById('contacts-body');
            if (!tbody) return;
            if (!contacts || contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">No contacts yet.</td></tr>';
                return;
            }
            tbody.innerHTML = contacts.map(c => {
                const date = c.created_at ? new Date(c.created_at).toLocaleDateString() : '-';
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-800">${c.client_name || '-'}</td>
                        <td class="px-6 py-4 text-gray-600">${c.phone_number || '-'}</td>
                        <td class="px-6 py-4 text-gray-600 max-w-xs truncate" title="${c.address || ''}">${c.address || '-'}</td>
                        <td class="px-6 py-4 text-gray-500 text-xs font-mono">${date}</td>
                    </tr>
                `;
            }).join('');
        }

        window.filterContacts = function() {
            const query = document.getElementById('contacts-search').value.toLowerCase();
            const filtered = allContacts.filter(c =>
                (c.client_name || '').toLowerCase().includes(query) ||
                (c.address || '').toLowerCase().includes(query) ||
                (c.phone_number || '').toLowerCase().includes(query)
            );
            renderContactsTable(filtered);
        };

        init();
    </script>
</body>
</html>
