<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bin Detective Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#ec1313", "dark": "#221010" },
                    fontFamily: { "display": ["Lexend", "sans-serif"] }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-slate-900 font-display min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-center">
        <div class="w-20 h-20 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-outlined text-4xl">lock</span>
        </div>
        <h2 class="text-2xl font-black mb-2">Secure Sign In</h2>
        <p class="text-gray-500 text-sm mb-6">Use your email and password to continue.</p>
        <div class="flex flex-col gap-3 text-left">
            <input type="email" id="auth-email" placeholder="Email address" autocomplete="email"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            <input type="text" id="auth-company" placeholder="Company name"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
        </div>
        <div class="grid grid-cols-2 gap-3 mt-5">
            <button onclick="signIn()" class="w-full h-12 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                SIGN IN
            </button>
            <button onclick="signUp()" class="w-full h-12 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                SIGN UP
            </button>
        </div>
        <button type="button" onclick="requestPasswordReset()" class="mt-4 text-xs font-bold text-gray-400 hover:text-primary transition-colors">
            Forgot password?
        </button>
        <p id="auth-message" class="text-xs text-gray-500 mt-4 min-h-[16px]"></p>
    </div>

    <script>
        const supabaseUrl = 'https://sjpzozgslahdzwqwjtbr.supabase.co';
        const supabaseKey = 'sb_publishable_t01aoRgIetSZ1Fuz0VSrgg_twswmqZV';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentCompanyId = null;

        function setAuthMessage(message, isError = false) {
            const el = document.getElementById('auth-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-4 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        async function loadCompanyId() {
            const { data } = await supabase
                .from('company_users')
                .select('company_id')
                .eq('user_id', currentUser.id)
                .maybeSingle();
            if (data?.company_id) {
                currentCompanyId = data.company_id;
                return true;
            }
            return false;
        }

        async function ensureCompanyMembership() {
            const companyName = document.getElementById('auth-company').value.trim();
            const email = (currentUser?.email || '').trim();
            if (!companyName || !email) {
                setAuthMessage('Enter your company name to continue.', true);
                return false;
            }
            const { error } = await supabase.rpc('claim_company_by_email', {
                p_company_name: companyName,
                p_email: email
            });
            if (error && !String(error.message).toLowerCase().includes('duplicate key')) {
                setAuthMessage(error.message, true);
                return false;
            }
            return loadCompanyId();
        }

        async function postAuthInit() {
            if (!currentUser) return;
            const hasCompany = await loadCompanyId();
            if (!hasCompany) {
                const claimed = await ensureCompanyMembership();
                if (!claimed) return;
            }
            window.location.href = "manage.html";
        }

        window.signIn = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.signUp = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: "https://jaybuildsthings.github.io/BinDetectiveV1/login.html"
                }
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            if (!data.session) {
                setAuthMessage('Check your email to confirm your account.');
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.requestPasswordReset = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            if (!email) {
                setAuthMessage('Enter your email to reset your password.', true);
                return;
            }
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: "https://jaybuildsthings.github.io/BinDetectiveV1/set-password.html"
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            setAuthMessage('If the email is registered, a password reset link has been sent.');
        };
    </script>
</body>
</html>
