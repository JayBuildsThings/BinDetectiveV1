<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bin Detective Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#ec1313", "dark": "#221010" },
                    fontFamily: { "display": ["Lexend", "sans-serif"] }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-slate-900 font-display min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-center">
        <div class="w-20 h-20 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-outlined text-4xl">lock</span>
        </div>
        <h2 class="text-2xl font-black mb-2">Secure Sign In</h2>
        <p class="text-gray-500 text-sm mb-6">Use your email and password to continue.</p>
        <div class="flex flex-col gap-3 text-left">
            <input type="email" id="auth-email" placeholder="Email address" autocomplete="email"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            <input type="text" id="auth-company" placeholder="Company name"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
        </div>
        <div class="grid grid-cols-2 gap-3 mt-5">
            <button onclick="signIn()" class="w-full h-12 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                SIGN IN
            </button>
            <button onclick="signUp()" class="w-full h-12 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                SIGN UP
            </button>
        </div>
        <button type="button" onclick="requestPasswordReset()" class="mt-4 text-xs font-bold text-gray-400 hover:text-primary transition-colors">
            Forgot password?
        </button>
        <p id="auth-message" class="text-xs text-gray-500 mt-4 min-h-[16px]"></p>
    </div>

    <script>
        const supabaseUrl = 'https://sjpzozgslahdzwqwjtbr.supabase.co';
        const supabaseKey = 'sb_publishable_t01aoRgIetSZ1Fuz0VSrgg_twswmqZV';
        const originalFetch = window.fetch.bind(window);
        const wrappedSupabaseFetch = async function(resource, options) {
            const url = typeof resource === 'string' ? resource : resource?.url;
            const isCompanyUsers = typeof url === 'string' && url.includes('/rest/v1/company_users');
            const startedAt = Date.now();
            if (isCompanyUsers) {
                // #region agent log
                originalFetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:fetchOverride',message:'company_users request start',data:{method:options?.method||'GET'},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
            }
            try {
                const response = await originalFetch(resource, options);
                if (isCompanyUsers) {
                    // #region agent log
                    originalFetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:fetchOverride',message:'company_users request end',data:{status:response.status,ok:response.ok,durationMs:Date.now()-startedAt},timestamp:Date.now()})}).catch(()=>{});
                    // #endregion
                }
                return response;
            } catch (error) {
                if (isCompanyUsers) {
                    // #region agent log
                    originalFetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:fetchOverride',message:'company_users request error',data:{errorName:error?.name||'unknown',durationMs:Date.now()-startedAt},timestamp:Date.now()})}).catch(()=>{});
                    // #endregion
                }
                throw error;
            }
        };
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            global: { fetch: wrappedSupabaseFetch }
        });
        const projectRef = new URL(supabaseUrl).hostname.split('.')[0];
        const authStorageKey = `sb-${projectRef}-auth-token`;

        let currentUser = null;
        let currentCompanyId = null;
        let autoLoginInProgress = false;

        function setAuthMessage(message, isError = false) {
            const el = document.getElementById('auth-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-4 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        async function loadCompanyId() {
            const start = Date.now();
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:loadCompanyId',message:'company lookup start',data:{hasUser:!!currentUser},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            const slowTimer = setTimeout(() => {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:loadCompanyId',message:'company lookup slow >3000ms',data:{elapsedMs:Date.now()-start},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
            }, 3000);
            const { data, error } = await supabase
                .from('company_users')
                .select('company_id')
                .eq('user_id', currentUser.id)
                .maybeSingle();
            clearTimeout(slowTimer);
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:loadCompanyId',message:'company lookup result',data:{hasData:!!data,companyIdPresent:!!data?.company_id,hasError:!!error,errorCode:error?.code||null,errorStatus:error?.status||null,durationMs:Date.now()-start},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            if (data?.company_id) {
                currentCompanyId = data.company_id;
                return true;
            }
            return false;
        }

        async function ensureCompanyMembership() {
            const companyName = document.getElementById('auth-company').value.trim();
            const email = (currentUser?.email || '').trim();
            if (!companyName || !email) {
                setAuthMessage('Enter your company name to continue.', true);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:ensureCompanyMembership',message:'missing company name or email',data:{hasCompanyName:!!companyName,hasEmail:!!email},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
                return false;
            }
            const { error } = await supabase.rpc('claim_company_by_email', {
                p_company_name: companyName,
                p_email: email
            });
            if (error && !String(error.message).toLowerCase().includes('duplicate key')) {
                setAuthMessage(error.message, true);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:ensureCompanyMembership',message:'claim failed',data:{hasError:true},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
                return false;
            }
            return loadCompanyId();
        }

        async function postAuthInit() {
            if (!currentUser) return;
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:postAuthInit',message:'postAuthInit start',data:{hasUser:!!currentUser},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            const hasCompany = await loadCompanyId();
            if (!hasCompany) {
                const claimed = await ensureCompanyMembership();
                if (!claimed) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:postAuthInit',message:'postAuthInit blocked',data:{reason:'claim_failed'},timestamp:Date.now()})}).catch(()=>{});
                    // #endregion
                    return;
                }
            }
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run20',hypothesisId:'H23',location:'login.html:postAuthInit',message:'postAuthInit continuing',data:{hasCompany:!!currentCompanyId},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:postAuthInit',message:'postAuthInit redirect',data:{hasCompany:true},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            window.location.href = "manage.html";
        }

        window.signIn = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:signIn',message:'missing credentials',data:{hasEmail:!!email,hasPassword:!!password},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
                return;
            }
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:signIn',message:'signIn start',data:{},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                setAuthMessage(error.message, true);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:signIn',message:'signIn error',data:{hasError:true},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
                return;
            }
            currentUser = data.user;
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run19',hypothesisId:'H22',location:'login.html:signIn',message:'signIn success',data:{hasUser:!!currentUser},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            await postAuthInit();
        };

        window.signUp = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: "https://jaybuildsthings.github.io/BinDetectiveV1/login.html"
                }
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            if (!data.session) {
                setAuthMessage('Check your email to confirm your account.');
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.requestPasswordReset = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            if (!email) {
                setAuthMessage('Enter your email to reset your password.', true);
                return;
            }
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: "https://jaybuildsthings.github.io/BinDetectiveV1/set-password.html"
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            setAuthMessage('If the email is registered, a password reset link has been sent.');
        };

        async function initExistingSession(trigger) {
            if (autoLoginInProgress) return;
            autoLoginInProgress = true;
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run21',hypothesisId:'H24',location:'login.html:initExistingSession',message:'session check start',data:{trigger},timestamp:Date.now()})}).catch(()=>{});
            // #endregion
            const { data } = await supabase.auth.getSession();
            if (data.session) {
                currentUser = data.session.user;
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/67eb3f48-ab69-4342-b4f8-aedc8e2c2b1b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:'debug-session',runId:'run21',hypothesisId:'H24',location:'login.html:initExistingSession',message:'session found',data:{hasUser:!!currentUser},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
                await postAuthInit();
            }
            autoLoginInProgress = false;
        }

        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                initExistingSession('auth_state');
            }
        });

        window.addEventListener('storage', (e) => {
            if (e.key === authStorageKey) {
                initExistingSession('storage');
            }
        });

        initExistingSession('load');
    </script>
</body>
</html>
