<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <meta name="theme-color" content="#ec1313">
    <title>Bin Detective Manager</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700;800&family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgAjnhHwg21ujdM12Y4VDlNOg8ujpxcP4&libraries=places"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>

    <script>
        // --- NAVIGATION & UI ---
        window.navigateTo = function(viewId) {
            const views = document.querySelectorAll('.view');
            views.forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            const target = document.getElementById(viewId);
            if(target) {
                target.style.display = 'block';
                requestAnimationFrame(() => {
                    target.classList.add('active');
                    window.scrollTo(0, 0);
                    if(viewId === 'view-log-activity') {
                        updateTimeField();
                        closeAllDropdowns({target: document.body});
                    } else if(viewId === 'view-bin-locations') {
                        loadBinLocations();
                    } else if(viewId === 'view-contacts') {
                        loadContacts();
                    } else if(viewId === 'view-requests') {
                        loadRequests();
                    }
                });
            }
        };

        window.openMaps = function(address) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
        };

        function updateTimeField() {
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const el = document.getElementById('log-display-date');
            if(el) el.innerText = dateStr;
        }

        window.showToast = function(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMsg = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            toastMsg.innerText = message;
            toast.className = `fixed top-6 left-1/2 -translate-x-1/2 bg-surface-dark text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 min-w-[300px] border-l-4 ${isError ? 'border-red-500' : 'border-green-500'} transition-all duration-300 transform scale-100 opacity-100`;
            toastIcon.innerText = isError ? "error" : "check_circle";
            setTimeout(() => {
                toast.classList.add('opacity-0', 'scale-90', 'pointer-events-none');
            }, 3000);
        };
    </script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ec1313", "primary-yellow": "#f9f506", "background-light": "#f8f6f6", "background-dark": "#221010", "surface-light": "#ffffff", "surface-dark": "#27272a", "status-pickup": "#10b981", "status-issue": "#ef4444", "status-not-assigned": "#9ca3af", "input-light": "#f0f0eb", "input-dark": "#363528" },
                    fontFamily: { "display": ["Lexend", "sans-serif"], "body": ["Noto Sans", "sans-serif"] },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"}
                }
            }
        }
    </script>
    <style>
        body { min-height: 100dvh; background-color: #f8f6f6; overflow-x: hidden; }
        .view { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .view.active { opacity: 1; }
        #view-main-menu { display: block; opacity: 1; }
        .custom-dropdown::-webkit-scrollbar { width: 4px; }
        .custom-dropdown::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="antialiased text-slate-900 dark:text-white" onclick="closeAllDropdowns(event)">

    <!-- SHARED AUTH LOCK SCREEN -->
    <div id="lock-screen" class="fixed inset-0 z-[100] bg-dark flex items-center justify-center p-6 hidden">
        <div class="max-w-sm w-full bg-white rounded-3xl p-8 shadow-2xl text-center">
            <div class="w-20 h-20 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="material-symbols-outlined text-4xl">lock</span>
            </div>
            <h2 class="text-2xl font-black mb-2">Secure Sign In</h2>
            <p class="text-gray-500 text-sm mb-6">Use your email and password to continue.</p>
            <div class="flex flex-col gap-3 text-left">
                <input type="email" id="auth-email" placeholder="Email address" autocomplete="email"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
                <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
                <input type="text" id="auth-company" placeholder="Company name"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            </div>
            <div class="grid grid-cols-2 gap-3 mt-5">
                <button onclick="signIn()" class="w-full h-12 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                    SIGN IN
                </button>
                <button onclick="signUp()" class="w-full h-12 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                    SIGN UP
                </button>
            </div>
            <button type="button" onclick="requestPasswordReset()" class="mt-4 text-xs font-bold text-gray-400 hover:text-primary transition-colors">
                Forgot password?
            </button>
            <p id="auth-message" class="text-xs text-gray-500 mt-4 min-h-[16px]"></p>
        </div>
    </div>

    <!-- PASSWORD RESET MODAL -->
    <div id="reset-password-modal" class="fixed inset-0 z-[110] bg-black/40 hidden items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-black text-dark">Set Password</h2>
                <button onclick="closeResetPassword()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <p class="text-xs text-gray-500 mb-4">Create a password for your account.</p>
            <div class="flex flex-col gap-3">
                <input type="password" id="reset-password" placeholder="New password"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
                <input type="password" id="reset-password-confirm" placeholder="Confirm new password"
                       class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            </div>
            <p id="reset-message" class="text-xs text-gray-500 mt-3 min-h-[16px]"></p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeResetPassword()" class="flex-1 h-11 rounded-xl bg-gray-100 text-gray-600 font-bold">Cancel</button>
                <button onclick="submitPasswordReset()" class="flex-1 h-11 rounded-xl bg-primary text-white font-bold">Update</button>
            </div>
        </div>
    </div>

    <!-- LOGOUT CONFIRM MODAL -->
    <div id="logout-modal" class="fixed inset-0 z-[110] bg-black/40 hidden items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl text-center">
            <div class="w-16 h-16 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-3xl">logout</span>
            </div>
            <h2 class="text-lg font-black text-dark mb-2">Log out?</h2>
            <p class="text-xs text-gray-500 mb-6">Are you sure you want to log out?</p>
            <div class="flex gap-3">
                <button onclick="closeLogoutModal()" class="flex-1 h-11 rounded-xl bg-gray-100 text-gray-600 font-bold">Cancel</button>
                <button onclick="confirmLogout()" class="flex-1 h-11 rounded-xl bg-primary text-white font-bold">Log out</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD ACCESS MODAL -->
    <div id="dashboard-access-modal" class="fixed inset-0 z-[110] bg-black/40 hidden items-center justify-center p-6">
        <div class="w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl text-center">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-3xl">admin_panel_settings</span>
            </div>
            <h2 class="text-lg font-black text-dark mb-2">Admin only</h2>
            <p class="text-xs text-gray-500 mb-6">This is only for admins.</p>
            <button onclick="closeDashboardAccessModal()" class="w-full h-11 rounded-xl bg-primary text-white font-bold">Okay</button>
        </div>
    </div>

    <!-- TOAST COMPONENT -->
    <div id="toast-notification" class="fixed top-6 left-1/2 -translate-x-1/2 bg-surface-dark text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 min-w-[300px] transition-all duration-300 transform scale-90 opacity-0 pointer-events-none">
        <span id="toast-icon" class="material-symbols-outlined">info</span>
        <span id="toast-message" class="font-bold text-sm"></span>
    </div>

    <!-- ================= VIEW: MAIN MENU ================= -->
    <section id="view-main-menu" class="view active">
        <div class="flex flex-col min-h-screen p-6 max-w-md mx-auto relative pb-20">
            <header class="flex flex-col mt-8 mb-8">
                <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">BIN<span class="text-primary">DETECTIVE</span></h1>
                <p class="text-lg text-slate-500 dark:text-slate-400 font-medium mt-1">Management Portal</p>
            </header>

            <div class="flex-1 flex flex-col gap-5">
                <button type="button" onclick="navigateTo('view-log-activity')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-primary active:border-primary cursor-pointer">
                    <div class="absolute inset-0 bg-primary opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-red-100 text-primary dark:bg-red-900/30 dark:text-red-400">
                            <span class="material-symbols-outlined !text-6xl">add_task</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-primary">LOG ACTIVITY</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Report collection or issues</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-primary">arrow_forward_ios</span></div>
                    </div>
                </button>

                <button type="button" onclick="navigateTo('view-bin-locations')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-yellow-400 active:border-yellow-400 cursor-pointer">
                    <div class="absolute inset-0 bg-yellow-400 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400">
                            <span class="material-symbols-outlined !text-6xl">map</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-yellow-600">BIN LOCATIONS</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Map view & status</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-yellow-600">arrow_forward_ios</span></div>
                    </div>
                </button>

                <button type="button" onclick="navigateTo('view-contacts')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-orange-500 active:border-orange-500 cursor-pointer">
                    <div class="absolute inset-0 bg-orange-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400">
                            <span class="material-symbols-outlined !text-6xl">perm_contact_calendar</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-orange-600">CONTACT LIST</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Names, address & phone numbers</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-orange-600">arrow_forward_ios</span></div>
                    </div>
                </button>

                <!-- REQUESTS BUTTON -->
                <button type="button" onclick="navigateTo('view-requests')" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-blue-500 active:border-blue-500 cursor-pointer">
                    <div class="absolute inset-0 bg-blue-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400">
                            <span class="material-symbols-outlined !text-6xl">assignment</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-blue-600">REQUESTS</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Client service requests</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-blue-600">arrow_forward_ios</span></div>
                    </div>
                </button>

                <button id="dashboard-tile" type="button" onclick="openDashboard()" class="group relative w-full overflow-hidden rounded-2xl bg-white dark:bg-slate-800 shadow-lg shadow-slate-200/50 dark:shadow-black/20 transition-all active:scale-[0.98] border-2 border-transparent focus:border-purple-500 active:border-purple-500 cursor-pointer">
                    <div class="absolute inset-0 bg-purple-500 opacity-0 group-active:opacity-10 transition-opacity"></div>
                    <div class="flex flex-row items-center h-36 p-4 gap-6">
                        <div class="flex shrink-0 items-center justify-center w-24 h-24 rounded-xl bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400">
                            <span class="material-symbols-outlined !text-6xl">dashboard</span>
                        </div>
                        <div class="flex flex-col items-start justify-center text-left max-w-[160px]">
                            <span class="text-2xl font-extrabold text-slate-900 dark:text-white leading-none mb-1 group-active:text-purple-600">DASHBOARD</span>
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400 leading-tight">Admin overview</span>
                        </div>
                        <div class="ml-auto pr-2"><span class="material-symbols-outlined text-4xl text-slate-300 group-active:text-purple-600">arrow_forward_ios</span></div>
                    </div>
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="logout()" class="text-xs font-bold text-slate-300 dark:text-slate-700 hover:text-red-500">LOGOUT</button>
            </div>
        </div>
    </section>

    <!-- ================= VIEW: LOG ACTIVITY ================= -->
    <section id="view-log-activity" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto relative bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 active:bg-black/10 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Log Activity</h1>
            </div>

            <div class="flex-1 flex flex-col gap-5">

                <!-- 1. Activity Type -->
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Activity Type</label>
                    <div class="relative">
                        <select id="log-type" onchange="autoFillBinDetails()" class="w-full h-14 pl-4 pr-12 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm appearance-none cursor-pointer">
                            <option value="Deliver">Deliver</option>
                            <option value="PickUp">PickUp</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><span class="material-symbols-outlined text-2xl">expand_more</span></div>
                    </div>
                </div>
                
                <!-- 2. Bin # -->
                <div class="flex flex-col gap-2 relative z-40">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Bin #</label>
                    <div class="relative">
                        <input type="text" id="log-bin-id" placeholder="Select Bin (e.g. 1)" autocomplete="off" 
                               class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm"
                               oninput="handleBinSearch(this)" onfocus="handleBinSearch(this)" onblur="autoFillBinDetails()">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">qr_code_2</span>
                        
                        <!-- Bin Dropdown -->
                        <div id="suggestions-bin" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <!-- 3. Client Name -->
                <div class="flex flex-col gap-2 relative z-30">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Client Name</label>
                    <div class="relative">
                        <input type="text" id="log-client-name" placeholder="Name..." autocomplete="off" class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm" oninput="handleAutoFill(this, 'client_name')" onfocus="handleAutoFill(this, 'client_name')">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">person</span>
                        <div id="suggestions-client-name" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5"></div>
                    </div>
                </div>

                <!-- 4. Address -->
                <div class="flex flex-col gap-2 relative z-20">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Address</label>
                    <div class="relative">
                        <input type="text" id="log-address" placeholder="Enter address..." autocomplete="off" class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm" oninput="handleAutoFill(this, 'address')" onfocus="handleAutoFill(this, 'address')">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">location_on</span>
                        <div id="suggestions-address" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5"></div>
                    </div>
                </div>

                <!-- 5. Phone Number -->
                <div class="flex flex-col gap-2 relative z-10">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Phone Number</label>
                    <div class="relative">
                        <input type="tel" id="log-phone" placeholder="(555) 000-0000" autocomplete="off" class="w-full h-14 pl-12 pr-4 rounded-xl bg-input-light dark:bg-input-dark border-none focus:ring-2 focus:ring-primary text-lg font-medium text-gray-900 dark:text-white shadow-sm" oninput="handleAutoFill(this, 'phone_number')" onfocus="handleAutoFill(this, 'phone_number')">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">phone</span>
                        <div id="suggestions-phone-number" class="custom-dropdown absolute top-full left-0 right-0 mt-2 bg-white dark:bg-surface-dark shadow-xl rounded-xl max-h-60 overflow-y-auto hidden border border-gray-100 dark:border-white/5"></div>
                    </div>
                </div>

                <!-- 6. Date -->
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Date & Time</label>
                    <div class="flex items-center justify-start gap-3 h-14 w-full px-4 rounded-xl bg-gray-100 dark:bg-white/5 border border-transparent">
                        <span class="material-symbols-outlined text-2xl text-primary">schedule</span>
                        <span id="log-display-date" class="text-base font-bold text-gray-900 dark:text-white">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="fixed bottom-0 left-0 right-0 z-20 p-4 bg-gradient-to-t from-background-light via-background-light to-transparent dark:from-background-dark pointer-events-none">
                <div class="max-w-md mx-auto pointer-events-auto">
                    <button id="submit-btn" type="button" onclick="window.submitLog()" class="w-full h-14 bg-primary text-white font-display font-bold text-lg rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 cursor-pointer">
                        <span id="submit-btn-text">SUBMIT LOG</span>
                        <span id="submit-btn-icon" class="material-symbols-outlined">send</span>
                    </button>
                </div>
            </div>
        </main>
    </section>

    <!-- BIN LOCATIONS & CONTACTS -->
    <section id="view-bin-locations" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Bin Locations</h1>
            </div>
            <div id="bin-list-container" class="flex flex-col gap-4"><p class="text-center text-gray-500 animate-pulse mt-10">Fetching your vault...</p></div>
        </main>
    </section>

    <section id="view-contacts" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-4">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Contact List</h1>
            </div>
            <div class="mb-6 relative"><span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span><input type="text" id="contact-search" placeholder="Search..." class="w-full h-12 pl-12 pr-4 rounded-xl bg-white dark:bg-surface-dark border-none shadow-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary" oninput="filterContacts()"></div>
            <div id="contact-list-container" class="flex flex-col pb-20"><p class="text-center text-gray-500 animate-pulse mt-10">Fetching your vault...</p></div>
        </main>
    </section>

    <!-- REQUESTS -->
    <section id="view-requests" class="view">
        <main class="flex flex-col min-h-screen p-4 max-w-md mx-auto bg-background-light dark:bg-background-dark">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="navigateTo('view-main-menu')" class="p-2 -ml-2 rounded-full hover:bg-black/5 transition-colors cursor-pointer"><span class="material-symbols-outlined text-3xl text-gray-800 dark:text-white">arrow_back</span></button>
                <h1 class="font-display font-bold text-2xl text-gray-900 dark:text-white">Requests</h1>
            </div>
            <div id="requests-list-container" class="flex flex-col gap-4 pb-20">
                 <p class="text-center text-gray-500 mt-10 animate-pulse">Loading requests...</p>
            </div>
        </main>
    </section>

    <script>
        const supabaseUrl = 'https://sjpzozgslahdzwqwjtbr.supabase.co';
        const supabaseKey = 'sb_publishable_t01aoRgIetSZ1Fuz0VSrgg_twswmqZV';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        window.masterBins = []; 
        window.requestsData = []; 
        let currentCompanyId = null;
        let currentUser = null;
        let currentIsAdmin = false;
        let currentDashboardAccess = true;
        let addressSelected = false;
        let addressAutocomplete = null;
        let autoFillTimeouts = {};

        function showLockScreen(show) {
            const lockScreen = document.getElementById('lock-screen');
            lockScreen.classList.toggle('hidden', !show);
        }

        function redirectToLogin() {
            window.location.href = "login.html";
        }

        function showLogoutModal(show) {
            const modal = document.getElementById('logout-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        }

        function showDashboardAccessModal(show) {
            const modal = document.getElementById('dashboard-access-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        }

        window.closeDashboardAccessModal = function() {
            showDashboardAccessModal(false);
        };

        window.openDashboard = async function() {
            await loadAccessTier();
            if (currentIsAdmin && currentDashboardAccess) {
                window.location.href = "dashboard.html";
                return;
            }
            showDashboardAccessModal(true);
        };

        function updateDashboardTileVisibility() {
            const tile = document.getElementById('dashboard-tile');
            if (!tile) return;
            if (currentDashboardAccess) {
                tile.classList.remove('hidden');
            } else {
                tile.classList.add('hidden');
            }
        }

        window.closeLogoutModal = function() {
            showLogoutModal(false);
        };

        window.confirmLogout = async function() {
            try {
                await Promise.race([
                    supabase.auth.signOut(),
                    new Promise(resolve => setTimeout(resolve, 2000))
                ]);
            } catch (e) {
                console.warn('Logout failed', e);
            }
            showLogoutModal(false);
            redirectToLogin();
        };

        function setAuthMessage(message, isError = false) {
            const el = document.getElementById('auth-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-4 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        function showResetPassword(show) {
            const modal = document.getElementById('reset-password-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        }

        function setResetMessage(message, isError = false) {
            const el = document.getElementById('reset-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-3 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        function isPasswordSetupFlow() {
            const hash = window.location.hash || '';
            return hash.includes('type=recovery') || hash.includes('type=invite');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function runWithRetry(label, fn, attempts = 3) {
            let lastError;
            for (let attempt = 1; attempt <= attempts; attempt++) {
                const { data, error } = await fn();
                if (!error) return { data };
                lastError = error;
                console.warn(`${label} attempt ${attempt} failed`, error);
                await sleep(400 * attempt);
            }
            return { error: lastError };
        }

        function renderLoadError(container, message, retryFnName) {
            container.innerHTML = `
                <p class="text-center text-red-500 mt-10">
                    ${message}
                    <span class="block mt-3">
                        <button onclick="${retryFnName}()" class="text-xs font-bold text-primary underline">Retry</button>
                    </span>
                </p>`;
        }

        async function loadCompanyId() {
            const { data } = await supabase
                .from('company_users')
                .select('company_id')
                .eq('user_id', currentUser.id)
                .maybeSingle();
            if (data?.company_id) {
                currentCompanyId = data.company_id;
                return true;
            }
            return false;
        }

        async function loadAccessTier() {
            if (!currentCompanyId || !currentUser?.email) {
                currentIsAdmin = false;
                currentDashboardAccess = false;
                updateDashboardTileVisibility();
                return false;
            }
            const { data } = await supabase
                .from('company_allowed_emails')
                .select('is_admin,dashboard_access')
                .eq('company_id', currentCompanyId)
                .eq('email', currentUser.email)
                .maybeSingle();
            if (data) {
                currentIsAdmin = !!data.is_admin;
                currentDashboardAccess = data.dashboard_access !== false;
                updateDashboardTileVisibility();
                return true;
            }
            currentIsAdmin = false;
            currentDashboardAccess = false;
            updateDashboardTileVisibility();
            return false;
        }

        async function ensureCompanyMembership() {
            const companyName = document.getElementById('auth-company').value.trim();
            const email = (currentUser?.email || '').trim();
            if (!companyName || !email) {
                setAuthMessage('Enter your company name to continue.', true);
                return false;
            }
            const { error } = await supabase.rpc('claim_company_by_email', {
                p_company_name: companyName,
                p_email: email
            });
            if (error && !String(error.message).toLowerCase().includes('duplicate key')) {
                setAuthMessage(error.message, true);
                return false;
            }
            return loadCompanyId();
        }

        async function postAuthInit() {
            if (!currentUser) return;
            const hasCompany = await loadCompanyId();
            if (!hasCompany) {
                const claimed = await ensureCompanyMembership();
                if (!claimed) {
                    showLockScreen(true);
                    return;
                }
            }
            await loadAccessTier();
            showLockScreen(false);
            fetchMasterBins();
        }

        window.requestPasswordReset = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            if (!email) {
                setAuthMessage('Enter your email to reset your password.', true);
                return;
            }
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: `${window.location.origin}/BinDetectiveV1/set-password.html`
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            setAuthMessage('If the email is registered, a password reset link has been sent.');
        };

        window.closeResetPassword = function() {
            showResetPassword(false);
            setResetMessage('');
            const pwd = document.getElementById('reset-password');
            const confirm = document.getElementById('reset-password-confirm');
            if (pwd) pwd.value = '';
            if (confirm) confirm.value = '';
        };

        window.submitPasswordReset = async function() {
            setResetMessage('');
            const pwd = document.getElementById('reset-password').value.trim();
            const confirm = document.getElementById('reset-password-confirm').value.trim();
            if (!pwd || pwd.length < 6) {
                setResetMessage('Password must be at least 6 characters.', true);
                return;
            }
            if (pwd !== confirm) {
                setResetMessage('Passwords do not match.', true);
                return;
            }
            const { error } = await supabase.auth.updateUser({ password: pwd });
            if (error) {
                setResetMessage(error.message, true);
                return;
            }
            setResetMessage('Password updated. Please sign in again.');
            await supabase.auth.signOut();
            showResetPassword(false);
            showLockScreen(true);
        };

        window.signIn = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.signUp = async function() {
            setAuthMessage('');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) {
                setAuthMessage('Email and password are required.', true);
                return;
            }
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: "https://jaybuildsthings.github.io/BinDetectiveV1/manage.html"
                }
            });
            if (error) {
                setAuthMessage(error.message, true);
                return;
            }
            if (!data.session) {
                setAuthMessage('Check your email to confirm your account.');
                return;
            }
            currentUser = data.user;
            await postAuthInit();
        };

        window.logout = async function() {
            showLogoutModal(true);
        };

        async function initAuth() {
            const { data } = await supabase.auth.getSession();
            if (data.session && isPasswordSetupFlow()) {
                showLockScreen(true);
                showResetPassword(true);
                return;
            }
            if (!data.session) {
                redirectToLogin();
                return;
            } else {
                currentUser = data.session.user;
                await postAuthInit();
            }
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'PASSWORD_RECOVERY' || isPasswordSetupFlow()) {
                    showLockScreen(true);
                    showResetPassword(true);
                    return;
                }
                if (!session) {
                    currentUser = null;
                    currentCompanyId = null;
                    redirectToLogin();
                    return;
                }
                currentUser = session.user;
                await postAuthInit();
            });
        }

        async function fetchMasterBins() {
            const { data } = await supabase.from('master_bins').select('bin_id');
            if(data) {
                window.masterBins = data.map(b => b.bin_id).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
            }
        }

        window.handleBinSearch = function(input) {
            const val = input.value.trim().toLowerCase();
            const listEl = document.getElementById('suggestions-bin');
            document.querySelectorAll('.custom-dropdown').forEach(el => { if(el.id !== 'suggestions-bin') el.classList.add('hidden'); });

            const filtered = window.masterBins.filter(b => b.toLowerCase().includes(val));
            if(filtered.length === 0) { listEl.classList.add('hidden'); return; }

            listEl.innerHTML = filtered.map(b => `<div class="p-3.5 hover:bg-gray-100 dark:hover:bg-white/5 cursor-pointer text-lg font-medium border-b border-gray-100 dark:border-white/5" onclick="selectBin('${b}')">Bin #${b}</div>`).join('');
            listEl.classList.remove('hidden');
        };

        window.selectBin = function(binId) {
            document.getElementById('log-bin-id').value = binId;
            document.getElementById('suggestions-bin').classList.add('hidden');
            autoFillBinDetails(); 
        };

        window.autoFillBinDetails = async function() {
            const type = document.getElementById('log-type').value;
            const binId = document.getElementById('log-bin-id').value.trim();
            if (type !== 'PickUp' || !binId) return;

            try {
            const { data } = await supabase
                .from('activity_logs')
                .select('bin_id,client_name,address,phone_number')
                .eq('bin_id', binId)
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle();
                if (data) {
                    if (data.client_name) document.getElementById('log-client-name').value = data.client_name;
                    if (data.address) {
                        document.getElementById('log-address').value = data.address;
                        addressSelected = true;
                    }
                    if (data.phone_number) document.getElementById('log-phone').value = data.phone_number;
                    window.showToast("Bin details autofilled");
                }
            } catch (e) { console.error("Autofill error:", e); }
        };

        window.submitLog = async function() {
            const btn = document.getElementById('submit-btn');
            const binId = document.getElementById('log-bin-id').value.trim();
            const address = document.getElementById('log-address').value.trim();
            
            if(!binId) return window.showToast("Please select a Bin", true);
            if(!address) return window.showToast("Please enter an Address", true);
            if(!addressSelected) return window.showToast("Please select an address from suggestions or use your current location.", true);
            if(!currentCompanyId) return window.showToast("Company access missing. Please sign in again.", true);
            if (!window.masterBins.includes(binId)) return window.showToast(`Error: Bin #${binId} does not exist in Master List`, true);

            btn.disabled = true;
            document.getElementById('submit-btn-text').innerText = "Processing...";

            try {
                const { error } = await supabase.from('activity_logs').insert([{
                    company_id: currentCompanyId,
                    bin_id: binId,
                    client_name: document.getElementById('log-client-name').value,
                    address: address,
                    phone_number: document.getElementById('log-phone').value,
                    activity_type: document.getElementById('log-type').value
                }]);
                if (error) throw error;
                window.showToast("Activity Logged!");
                setTimeout(() => { location.reload(); }, 1000);
            } catch (err) {
                window.showToast(err.message, true);
                btn.disabled = false;
                document.getElementById('submit-btn-text').innerText = "SUBMIT LOG";
            }
        };

        window.loadBinLocations = async function() {
            const container = document.getElementById('bin-list-container');
            container.innerHTML = `<p class="text-center text-gray-500 mt-10 animate-pulse">Loading bin locations...</p>`;
            const res = await runWithRetry('bin locations', () => supabase
                .from('activity_logs')
                .select('bin_id,activity_type,address,created_at')
                .order('created_at', { ascending: false })
                .limit(1000));
            if (res.error) {
                renderLoadError(container, res.error.message || 'Unable to load bin locations.', 'loadBinLocations');
                return;
            }
            const data = res.data || [];
            
            const uniqueBins = new Map();
            data.forEach(log => { if(log.bin_id && !uniqueBins.has(log.bin_id)) uniqueBins.set(log.bin_id, log); });
            
            let binArray = Array.from(uniqueBins.values());
            binArray.sort((a, b) => {
                const aIsDelivered = a.activity_type === 'Deliver';
                const bIsDelivered = b.activity_type === 'Deliver';
                if (aIsDelivered && !bIsDelivered) return -1;
                if (!aIsDelivered && bIsDelivered) return 1;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            container.innerHTML = "";
            binArray.forEach(bin => {
                const isPickup = bin.activity_type === 'PickUp';
                const isDeliver = bin.activity_type === 'Deliver';
                let displayText = isPickup ? 'Not on site' : (isDeliver ? 'Delivered' : 'Unknown');

                const daysDiff = Math.floor((new Date() - new Date(bin.created_at)) / (1000 * 60 * 60 * 24));
                const daysText = daysDiff === 0 ? 'Today' : `${daysDiff} day${daysDiff === 1 ? '' : 's'}`;
                const daysHtml = isDeliver 
                    ? `<div class="text-[10px] text-green-700 font-medium mt-1 text-right">${daysText}</div>` 
                    : `<div class="text-[10px] text-gray-400 font-medium mt-1 text-right">${daysText} ago</div>`;

                container.innerHTML += `
                <article class="bg-surface-light dark:bg-surface-dark p-3.5 rounded-lg shadow-sm border-l-[6px] ${isPickup ? 'border-status-not-assigned' : 'border-status-pickup'}">
                    <div class="flex items-start gap-3">
                        <div class="h-14 w-14 shrink-0 rounded-md bg-primary-yellow text-black flex flex-col items-center justify-center font-bold border border-yellow-500">
                            <span class="text-[10px] uppercase opacity-80">Bin</span><span class="text-xl">${bin.bin_id}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="text-xl font-black">Bin #${bin.bin_id}</h4>
                                <div class="flex flex-col items-end">
                                    <span class="${isPickup ? 'bg-gray-100 text-gray-700' : 'bg-green-100 text-green-700'} text-[10px] font-bold px-1.5 py-0.5 rounded-md uppercase tracking-wide">${displayText}</span>
                                    ${daysHtml}
                                </div>
                            </div>
                            <div class="flex items-center gap-1.5 text-gray-500 text-sm cursor-pointer" onclick="openMaps('${bin.address}')">
                                <span class="material-symbols-outlined text-[18px]">location_on</span>
                                <span class="underline decoration-dotted">${bin.address}</span>
                            </div>
                        </div>
                    </div>
                </article>`;
            });
        };

        window.loadContacts = async function() {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = `<p class="text-center text-gray-500 mt-10 animate-pulse">Fetching your vault...</p>`;
            const res = await runWithRetry('contacts', () => supabase
                .from('activity_logs')
                .select('client_name,address,phone_number,created_at')
                .order('created_at', { ascending: false })
                .limit(1000));
            if (res.error) {
                renderLoadError(container, res.error.message || 'Unable to load contacts.', 'loadContacts');
                return;
            }
            const data = res.data || [];
            const uniqueClients = new Map();
            data.forEach(log => { if(log.client_name && !uniqueClients.has(log.client_name)) uniqueClients.set(log.client_name, log); });
            window.allContacts = Array.from(uniqueClients.values()).sort((a,b) => a.client_name.localeCompare(b.client_name));
            renderContacts(window.allContacts);
        };

        function renderContacts(contacts) {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = contacts.map(c => `
                <div class="bg-white dark:bg-surface-dark rounded-xl p-4 shadow-sm mb-4 border border-gray-100 dark:border-white/5">
                    <div class="flex items-start gap-4">
                        <div class="h-12 w-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl font-bold shrink-0">${c.client_name[0]}</div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold mb-1">${c.client_name}</h3>
                            <p class="text-sm text-gray-500 mb-1 flex items-center gap-1"><span class="material-symbols-outlined text-sm">location_on</span>${c.address}</p>
                            <p class="text-sm text-gray-500 flex items-center gap-1"><span class="material-symbols-outlined text-sm">phone</span>${c.phone_number}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4"><a href="tel:${c.phone_number}" class="bg-green-100 text-green-700 h-10 rounded-md font-bold flex items-center justify-center gap-2 text-sm"><span class="material-symbols-outlined text-xl">call</span>Call</a><button onclick="openMaps('${c.address}')" class="bg-primary/10 text-primary h-10 rounded-md font-bold flex items-center justify-center gap-2 text-sm"><span class="material-symbols-outlined text-xl">directions</span>Directions</button></div>
                </div>`).join('');
        }

        // --- CONVERT REQUEST TO ACTIVITY ---
        window.convertRequestToActivity = function(index) {
            const req = window.requestsData[index];
            if (!req) return;

            // 1. Determine Activity Type
            let activityType = 'Deliver'; // Default
            if (req.request_type && req.request_type.toLowerCase().includes('pickup')) {
                activityType = 'PickUp';
            }

            // 2. Populate Log Activity Fields
            document.getElementById('log-type').value = activityType;
            document.getElementById('log-client-name').value = req.client_name || '';
            document.getElementById('log-address').value = req.address || '';
            addressSelected = !!req.address;
            document.getElementById('log-phone').value = req.phone || '';
            document.getElementById('log-bin-id').value = ''; // Reset bin ID as it needs to be selected manually

            // 3. Navigate
            navigateTo('view-log-activity');
            window.showToast("Details autofilled from request");
        };

        window.loadRequests = async function() {
            const container = document.getElementById('requests-list-container');
            container.innerHTML = `<p class="text-center text-gray-500 mt-10 animate-pulse">Loading requests...</p>`;
            
            try {
                // Fetch All Requests (Unsorted by SQL)
                const res = await runWithRetry('requests', () => supabase
                    .from('service_requests')
                    .select('request_type,client_name,address,notes,created_at,phone')
                    .order('created_at', { ascending: false })
                    .limit(100));
                if (res.error) throw res.error;
                const data = res.data || [];
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-10">No pending requests.</p>`;
                    return;
                }

                // SAVE DATA FOR CLICK HANDLER
                window.requestsData = data.sort((a, b) => {
                    const getEffectiveDate = (req) => {
                        const match = (req.notes || '').match(/(NEEDED ON|PICKUP ON):\s*(\d{4}-\d{2}-\d{2})/);
                        return match ? new Date(match[2]) : new Date(req.created_at);
                    };
                    const dayA = new Date(getEffectiveDate(a)).setHours(0,0,0,0);
                    const dayB = new Date(getEffectiveDate(b)).setHours(0,0,0,0);
                    
                    if (dayA !== dayB) return dayA - dayB;
                    return new Date(a.created_at) - new Date(b.created_at);
                });

                container.innerHTML = window.requestsData.map((req, index) => {
                    const isPickup = req.request_type === 'Pickup';
                    const icon = isPickup ? 'local_shipping' : 'delete';
                    const color = isPickup ? 'text-green-600 bg-green-50' : 'text-blue-600 bg-blue-50';
                    const dateStr = new Date(req.created_at).toLocaleDateString();

                    let displayNotes = req.notes || '';
                    let dateBadgeHtml = '';
                    
                    const dateMatch = displayNotes.match(/(NEEDED ON|PICKUP ON):\s*(\d{4}-\d{2}-\d{2})/);
                    
                    if (dateMatch) {
                        const dateVal = dateMatch[2];
                        displayNotes = displayNotes.replace(dateMatch[0], '').trim();
                        
                        const targetDate = new Date(dateVal);
                        const today = new Date();
                        const diffTime = targetDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        let badgeColor = "bg-gray-100 text-gray-600 border-gray-200"; 
                        if (diffDays <= 1) badgeColor = "bg-orange-100 text-orange-700 border-orange-200";

                        dateBadgeHtml = `
                            <div class="mt-2 flex">
                                <span class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-bold border ${badgeColor}">
                                    <span class="material-symbols-outlined text-sm">calendar_month</span>
                                    Scheduled: ${dateVal}
                                </span>
                            </div>
                        `;
                    }

                    return `
                    <div class="bg-white dark:bg-surface-dark rounded-xl p-4 shadow-sm border border-gray-100 dark:border-white/5">
                        <div class="flex items-start gap-3">
                            <div class="h-12 w-12 rounded-full ${color} flex items-center justify-center shrink-0">
                                <span class="material-symbols-outlined text-2xl">${icon}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">${req.request_type}</h3>
                                    <span class="text-xs font-bold text-gray-400">${dateStr}</span>
                                </div>
                                <p class="text-sm font-bold text-gray-700 dark:text-gray-300 mt-1">${req.client_name}</p>
                                <p class="text-sm text-gray-500 flex items-center gap-1 mt-1"><span class="material-symbols-outlined text-sm">location_on</span>${req.address}</p>
                                
                                ${dateBadgeHtml}

                                ${displayNotes ? `<p class="text-sm text-slate-700 dark:text-slate-300 mt-3 bg-slate-50 dark:bg-white/5 p-3 rounded-lg border border-slate-100 dark:border-white/10">"${displayNotes}"</p>` : ''}
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-2">
                             <!-- NEW TURN INTO ACTIVITY BUTTON -->
                             <button onclick="convertRequestToActivity(${index})" class="w-full h-10 bg-primary text-white rounded-lg flex items-center justify-center font-bold text-sm gap-2 shadow-sm hover:bg-red-600 active:scale-95 transition-all">
                                <span class="material-symbols-outlined text-lg">add_task</span> Turn into Activity
                            </button>
                             <button onclick="openMaps('${req.address}')" class="w-full h-10 bg-blue-100 text-blue-700 rounded-lg flex items-center justify-center font-bold text-sm gap-2">
                                <span class="material-symbols-outlined text-lg">map</span> Open Maps
                            </button>
                            <a href="tel:${req.phone}" class="w-full h-10 bg-green-100 text-green-700 rounded-lg flex items-center justify-center font-bold text-sm gap-2">
                                <span class="material-symbols-outlined text-lg">call</span> Call
                            </a>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch(e) {
                console.error(e);
                renderLoadError(container, e.message || 'Error loading requests.', 'loadRequests');
            }
        };

        function initAddressAutocomplete() {
            const input = document.getElementById('log-address');
            if (!input || !window.google || !google.maps || !google.maps.places) return;
            addressAutocomplete = new google.maps.places.Autocomplete(input, {
                fields: ["formatted_address", "geometry", "place_id"],
                componentRestrictions: { country: "za" }
            });
            addressAutocomplete.addListener("place_changed", () => {
                const place = addressAutocomplete.getPlace();
                if (!place || !place.formatted_address) {
                    addressSelected = false;
                    return;
                }
                input.value = place.formatted_address;
                input.dataset.placeId = place.place_id || '';
                if (place.geometry?.location) {
                    input.dataset.lat = place.geometry.location.lat();
                    input.dataset.lon = place.geometry.location.lng();
                }
                addressSelected = true;
            });
        }


        window.handleAutoFill = async function(input, dbColumn) {
            const val = input.value.trim();
            const listId = `suggestions-${dbColumn.replace('_', '-')}`;
            const listEl = document.getElementById(listId);
            
            if(dbColumn === 'client_name' && val === '') {
                document.getElementById('log-address').value = '';
                document.getElementById('log-phone').value = '';
                addressSelected = false;
            }

            if (dbColumn === 'address') {
                addressSelected = false;
                return;
            }

            if (autoFillTimeouts[dbColumn]) {
                clearTimeout(autoFillTimeouts[dbColumn]);
            }

            if(val.length < 1) { listEl.classList.add('hidden'); return; }
            document.querySelectorAll('.custom-dropdown').forEach(d => { if(d.id !== listId) d.classList.add('hidden'); });

            autoFillTimeouts[dbColumn] = setTimeout(async () => {
                if (input.value.trim() !== val) return;
                const { data } = await supabase
                    .from('activity_logs')
                    .select(dbColumn)
                    .ilike(dbColumn, `%${val}%`)
                    .limit(5);
                if(!data || data.length === 0) return;
                
                listEl.innerHTML = [...new Set(data.map(d => d[dbColumn]))].map(v => 
                    `<div class="p-3.5 hover:bg-gray-100 dark:hover:bg-white/5 cursor-pointer text-sm border-b border-gray-100 dark:border-white/5" onclick="selectSug('${v}', '${dbColumn}')">${v}</div>`
                ).join('');
                listEl.classList.remove('hidden');
            }, 400);
        };

        window.selectSug = async function(val, col) {
            document.getElementById(`log-${col.replace('_', '-')}`).value = val;
            document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden'));
            
            const { data } = await supabase
                .from('activity_logs')
                .select('bin_id,client_name,address,phone_number')
                .eq(col, val)
                .order('created_at', { ascending: false })
                .limit(1);

            if(data[0]) {
                if(data[0].bin_id) document.getElementById('log-bin-id').value = data[0].bin_id;
                if(data[0].client_name) document.getElementById('log-client-name').value = data[0].client_name;
                if(data[0].address) {
                    document.getElementById('log-address').value = data[0].address;
                    addressSelected = true;
                }
                if(data[0].phone_number) document.getElementById('log-phone').value = data[0].phone_number;
            }
        };

        window.closeAllDropdowns = (e) => { 
            if(e.target.tagName !== 'INPUT' && !e.target.classList.contains('custom-dropdown')) {
                document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden')); 
            }
        };

        initAuth();
        initAddressAutocomplete();
    </script>
</body>
</html>
