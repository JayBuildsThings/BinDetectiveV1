<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Set Password | Bin Detective</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#ec1313", "dark": "#221010" },
                    fontFamily: { "display": ["Lexend", "sans-serif"] }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-slate-900 font-display min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-center">
        <div class="w-20 h-20 bg-red-50 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-outlined text-4xl">key</span>
        </div>
        <h2 class="text-2xl font-black mb-2">Set Password</h2>
        <p id="set-password-help" class="text-gray-500 text-sm mb-6">Create a password for your account.</p>
        <div class="flex flex-col gap-3 text-left">
            <input type="password" id="reset-password" placeholder="New password"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
            <input type="password" id="reset-password-confirm" placeholder="Confirm new password"
                   class="w-full h-12 bg-gray-100 border-none rounded-xl px-4 focus:ring-2 focus:ring-primary">
        </div>
        <button onclick="submitPasswordReset()" class="mt-5 w-full h-12 bg-primary text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
            Update Password
        </button>
        <p id="reset-message" class="text-xs text-gray-500 mt-4 min-h-[16px]"></p>
        <a href="login.html" class="block mt-4 text-xs font-bold text-gray-400 hover:text-primary transition-colors">Back to login</a>
    </div>

    <script>
        const supabaseUrl = 'https://sjpzozgslahdzwqwjtbr.supabase.co';
        const supabaseKey = 'sb_publishable_t01aoRgIetSZ1Fuz0VSrgg_twswmqZV';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function setResetMessage(message, isError = false) {
            const el = document.getElementById('reset-message');
            if (!el) return;
            el.innerText = message || '';
            el.className = `text-xs mt-4 min-h-[16px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        function isPasswordSetupFlow() {
            const hash = window.location.hash || '';
            return hash.includes('type=recovery') || hash.includes('type=invite');
        }

        async function ensureSession() {
            const { data } = await supabase.auth.getSession();
            return !!data.session;
        }

        async function init() {
            if (!isPasswordSetupFlow()) {
                setResetMessage('Invalid or expired link. Please request a new one.', true);
                return;
            }
            const hasSession = await ensureSession();
            if (!hasSession) {
                setResetMessage('Session missing. Please open the link again.', true);
                return;
            }
        }

        window.submitPasswordReset = async function() {
            setResetMessage('');
            const pwd = document.getElementById('reset-password').value.trim();
            const confirm = document.getElementById('reset-password-confirm').value.trim();
            if (!pwd || pwd.length < 6) {
                setResetMessage('Password must be at least 6 characters.', true);
                return;
            }
            if (pwd !== confirm) {
                setResetMessage('Passwords do not match.', true);
                return;
            }
            const { error } = await supabase.auth.updateUser({ password: pwd });
            if (error) {
                setResetMessage(error.message, true);
                return;
            }
            setResetMessage('Password updated. Please sign in.');
            await supabase.auth.signOut();
            setTimeout(() => {
                window.location.href = "login.html";
            }, 1200);
        };

        init();
    </script>
</body>
</html>
